---
title: "Data Wrangling"
subtitle: "The verbs of working with data frames"
author: Diogo Melo
date: Oct. 2nd, 2023
runtime: static
output:
  xaringan::moon_reader:
    css: [default, metropolis, metropolis-fonts, "styles.css","hygge"]
    nature:
      highlightLines: true
      chakra: libs/remark-latest.min.js
      beforeInit: "macros.js"
      ratio: "16:10"
      countdown: 60000
---

class: inverse, center, middle
# Messy data is a fact of life 

---

# Human data vs Computer data 

![](figures/human_data.png)]

---

# Human data vs Computer data 

![](figures/computer_data.png)]

---

# What not to do

.center[
![:scale 50%](figures/tweet.png)
]
[Journal declines to retract fish research paper despite fraud finding](https://www.science.org/content/article/journal-declines-retract-fish-research-paper-despite-fraud-finding#.Y-rB0HBL_Yo.twitter)

[The humanity!](https://zenodo.org/record/6565204)

[Tweet](https://twitter.com/rlmcelreath/status/1625414337232883712)

---

# The tidy data principles


.pull-left[
.content-box-yellow[
1. Each variable forms a column.

2. Each observation forms a row.

3. Each type of observational unit forms a table
]

### Things to solve:
- Column headers are values, not variable names.
- Multiple variables are stored in one column.
- Variables are stored in both rows and columns.
- Multiple types of observational units are stored in the same table.
- A single observational unit is stored in multiple tables

.ref[[Tidy data paper](https://www.jstatsoft.org/article/view/v059i10)]
]

---

# What should columns be?

.pull-left[
```{r}
library(tibble)
classroom <- tribble(
  ~name,    ~quiz1, ~quiz2, ~test1,
  "Billy",  NA,     "D",    "C",
  "Suzy",   "F",    NA,     NA,
  "Lionel", "B",    "C",    "B",
  "Jenny",  "A",    "A",    "B"
  )
classroom
```
]
--
.pull-right[
```{r}
tribble(
  ~assessment, ~Billy, ~Suzy, ~Lionel, ~Jenny,
  "quiz1",     NA,     "F",   "B",     "A",
  "quiz2",     "D",    NA,    "C",     "A",
  "test1",     "C",    NA,    "B",     "B"
  )
```
]

---

# Tidy it up!

```{r}
# install.packages(tidyverse)
library(tidyverse)
classroom2 <- classroom %>% 
  pivot_longer(quiz1:test1, names_to = "assessment", values_to = "grade") %>% 
  arrange(name, assessment)
classroom2
```

---

# Pivot: long and wide data

```{r}
relig_income
```

---

# pivot_longer


### Basic syntax:

```r
pivot_longer(data.frame, columns_to_join, names_to =  "names", values_to = "values")

```


### Equivalent calls:

```{r}
names(relig_income)
```
```r
relig_income %>% pivot_longer(-religion , names_to = "income", values_to = "frequency")

pivot_longer(relig_income, 2:11, names_to = "income", values_to = "frequency")

relig_income |> pivot_longer("<$10k":"Don't know/refused", names_to = "income", values_to = "frequency")

pivot_longer(relig_income, `<$10k`:`Don't know/refused`, names_to = "income", values_to = "frequency")
```

---


# tb dataset 

```{r}
who
```
---

# First, pivot longer
 
```{r}
tb2 <- who %>% 
  pivot_longer(
    !c(country , iso2 , iso3  , year), 
    names_to = "demo", 
    values_to = "n", 
    values_drop_na = TRUE
  )
tb2
```

---

# Now, separate the demo col

- The `demo` column is holding too many variables

- We need to get the species, sex and age variables into their own columns!

```r
separate(tb2, col = demo, into = c("species", "sex", "age"), ...)
```
```{r}
unique(tb2$demo)
```

--

```{r}
tb2 %>% separate(demo, c("sp", "sex", "age"), c(7,8))
```


---

# Regular expressions
```r
tb3 = who %>% pivot_longer(
   !c(country , iso2 , iso3  , year), 
  names_to = c("sp", "sex", "age"), 
  names_pattern = "(something) (something) (regex)"
  values_to = "n", 
  values_drop_na = TRUE)
tb3
```

---

# Regular expressions
```{r}
tb3 = who %>% pivot_longer(
   !c(country , iso2 , iso3  , year), 
  names_to = c("sp", "sex", "age"), 
  names_pattern = "new_?(.{2,3})_(.)(.+)", # canÂ´t beleive I got this right...
  values_to = "n", 
  values_drop_na = TRUE)
tb3
```

---


# More pivots

- Sometimes two columns are stored in the same one and must be separated

- This dataset has both problems!

```{r}
w_data = 'https://raw.githubusercontent.com/YonatanRA/-weather-project-data-cleaning-SQL-/master/weather-raw.csv'
weather <- as_tibble(read.csv(w_data, stringsAsFactors = FALSE))
weather
```

---

# Get the days in a column

```{r} 
weather2 <- weather %>% 
  pivot_longer(
    d1:d31, 
    names_to = "day", 
    values_to = "value", 
    values_drop_na = TRUE # Missing values are implicit in the long format
  ) 
weather2
```

---

# Pivot the `element` column wider

.pull-left[
```{r}
weather2
```
]
--
.pull-right[
```{r}
weather2 %>% 
  pivot_wider(names_from = element, 
              values_from = value)
```
]
---

class: inverse, center, middle
# The verbs of working with dataframes

---

# Base R vs **The tidyverse**

.pull-left[
- Most of the operations we will see can be done using just the stuff we already know:

   - Indexing with `[]` and `$`
   - Using logical comparisons `==`, `>`, ...
   - Creating new columns with `$`
   - `with` and `within` functions

- The [tidyverse](https://www.tidyverse.org/) gives us access to a consistent set of wrangling functions, which are well documented and fast

- They also play nice with the great ploting library `ggplot2`
]
.pull-right[
![](figures/tibble.png)
]
---

# Example data set

The infamous `flights` dataset in the `nycflights13` package

```{r}
library(tidyverse)
# pak::pkg_install("nycflights13")
library(nycflights13)
flights
```
---

# One table per observational unit

.center[
![](figures/relational-nycflights.png)
]
---

# Filter

`filter()` allows you to subset observations based on their values

```{r}
filter(flights, month == 1, day == 1) # multiple arguents are combined with "and" &
```

---

# Filter and the `%in%` operator

```{r}
sep_oct <- filter(flights, month %in% c(9, 10))
sep_oct
```

---

# Select

---

# Mutate

---


# Joins 

---

# Match

---


# col and row bind

---

# Summarize 

---

# Datatable alternatives

---